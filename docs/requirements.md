<!--
Depends On: None
Depended On By: docs/usecases.md, docs/ieee830.md
-->
# 要件定義書 (Requirements Document)

**プロジェクト規模:** ユーザー数 10,000人未満  
**開発手法:** AI-Driven Development (AIDD) / 段階的リリース戦略  
**文書バージョン:** 1.1 (Phase-based Architecture & Strategy)

## リリース戦略

### Phase 1 (初期リリース)
基本的なスケジュール管理機能と高度検索機能を提供し、従来システムからの移行と基本業務の効率化を実現します。

### Phase 2 (AI機能拡張)
生成AI技術を活用したスマート日程調整と会議準備サジェスト機能を追加し、さらなる業務効率化を図ります。

> [!NOTE]
> Phase 2のAI機能（スマート日程調整、会議準備サジェスト）は、Phase 1の安定稼働後に実装予定です。

## 1. システムアーキテクチャ戦略

1万人規模の同時アクセス（特に朝の始業時スパイク）に耐え、かつAIがコード生成しやすいモダンな構成を採用します。



### 1.1 技術スタック (Tech Stack)

#### Phase 1 技術スタック
AI（LLM）が学習データとして多く持っており、生成精度が最も高い技術選定を行います。

* **フロントエンド:** Next.js (React) + TypeScript + Tailwind CSS
    * *選定理由:* Vercel v0 等の生成AIツールとの親和性が最強であり、UIコンポーネントの自動生成が容易。
* **バックエンド:** Go (Golang)
    * *選定理由:* 型安全で記述が画一的なため、AIによるコード生成の品質が非常に安定する。並行処理に強く1万人規模のアクセスを捌きやすい。
* **データベース:** PostgreSQL (Managed Service)
* **キャッシュ:** Redis (必須)
    * *理由:* スケジュール参照はRead多頻度のため、RedisでキャッシュしないとDBがパンクする。
* **インフラ:** オンプレミス（物理サーバー/VM）+ Docker / Terraform
    * *理由:* 開発・テスト環境でのコスト効率と、顧客要件に応じたクラウド移行の柔軟性を確保。IaC (Infrastructure as Code) もAIに書かせるため、ナレッジが多いTerraformを採用。
* **デプロイ:** Docker コンテナ化による環境間移植性の確保
    * *理由:* オンプレ開発からクラウド本番への移行を容易にし、ベンダーロックインを回避。

#### Phase 2 追加技術スタック
* **AI/LLM:** OpenAI API / Google Gemini API
    * *理由:* 自然言語処理による日程調整機能の実現。
* **ベクトルDB:** Pinecone / Weaviate（クラウド）/ pgvector（オンプレ）
    * *理由:* 会議準備サジェスト用の文書検索・類似度計算。環境に応じて選択可能。

#### クラウド対応オプション
本システムはオンプレミス前提で設計されていますが、顧客要件に応じて以下のクラウド環境への移行が可能です：
* **AWS**: ECS + RDS + ElastiCache
* **Azure**: Container Instances + Azure Database + Redis Cache  
* **GCP**: Cloud Run + Cloud SQL + Memorystore

## 2. AI駆動開発プロセス (AI-Driven Development Strategy)

「フルスペックを効率よく」実現するため、以下の工程でAIをフル活用します。

### 2.1 要件定義・設計フェーズ (Human + AI)
* **DB設計:** 自然言語で要件を伝え、`dbdiagram.io` 形式のER図コードをAIに出力させる。
* **API定義:** Swagger (OpenAPI) 定義ファイルをAIに一括生成させ、これを「正」としてバックエンドとフロントエンドを並行開発する。

### 2.2 実装フェーズ (AI Agent)
* **ボイラープレート生成:**
    * 認証、ロギング、エラーハンドリング等の「面白くないが重要な基盤コード」は、Cursor (Claude 3.5 Sonnet) 等で一撃生成。
* **UI生成:**
    * v0.dev または Figma-to-Code AI を使用し、手書きのラフスケッチからReactコンポーネントを生成。
* **ロジック生成:**
    * 「空き時間検索アルゴリズム」などの複雑なロジックは、テストケースを先にAIに書かせ（TDD）、そのテストを通るコードをAIに書かせる。

### 2.3 テスト・品質保証 (AI Automated)
* **テストデータ生成:** 1万人分のダミーユーザーと、数百万件のスケジュールデータをAIに生成させ、負荷テストを実施。
* **自動E2Eテスト:** PlaywrightのテストスクリプトをAIに生成させ、全画面の操作テストを自動化。

## 3. 機能要件詳細 (Full Spec Definition)

1万人規模の企業利用に耐えうる「フルスペック」の内訳です。

### 3.1 エンタープライズ・コア機能
1.  **高度な繰り返し予定:**
    * 「毎月第3営業日」「四半期ごとの最終金曜日」など、複雑なビジネスルールに対応。
2.  **代理操作機能 (秘書機能):**
    * 役員等のスケジュールを秘書が代理で登録・変更できる権限委譲機能。
3.  **施設・備品管理の最適化:**
    * 会議室だけでなく、プロジェクター、社用車、Wi-Fiルーター等の備品管理。
    * 連続予約制限（特定の部屋の占有防止ロジック）。

### 3.2 高度検索・日程調整機能 (Phase 1)
従来の手動検索を大幅に効率化する高度な検索・フィルタリング機能を提供します。
* **複合条件検索:**
    * 参加者・期間・リソース条件を組み合わせた空き時間検索
    * 例：「来週の午後、田中さんと佐藤さんが空いている時間で、プロジェクター付きの会議室」
* **スマート候補提示:**
    * 条件に合致する候補を優先度順（移動時間、設備充実度等）で表示
    * 代替案の自動提案（時間帯変更、リソース変更等）

### 3.3 AIアシスタント機能 (Phase 2 - 将来実装)
> **Note:** 本機能群はPhase 2での実装予定です。Phase 1には含まれません。

生成AI技術を活用した次世代の日程調整機能を提供します。
* **スマート日程調整:**
    * 自然言語入力による日程調整：「A部長とB課長と開発チームで来週1時間」
    * 全員の空き時間と適切なサイズの会議室を自動提案
* **会議準備サジェスト:**
    * 予定のタイトル（例：「予算会議」）から、必要な資料テンプレートや過去の議事録をレコメンド
    * 過去の類似会議からのベストプラクティス提案

## 4. 非機能要件 (10,000 Users Scale)

### 4.1 SLO/SLI・パフォーマンス目標
* **スループット:** ピーク時 500 RPS を 95% タイルレイテンシ p95 ≤ 300ms、p99 ≤ 800ms で処理。
* **可用性:** 月間 99.9% 以上（計画メンテ除外）、エラーバジェット消費率を週次でモニタリング。
* **レートリミット:** ユーザー単位/テナント単位のスロットリング閾値を明記し、サーキットブレーカを適用。
* **データ整合性:** ダブルブッキングは DB の SERIALIZABLE 隔離レベルで排他。API レベルで冪等性キーをサポート。

### 4.2 可観測性・運用監視
* **ログ:** 構造化 JSON ログを ECS FireLens 経由で集中収集。PII をマスクし、監査ログは 1 年保管。
* **メトリクス:** RPS、レイテンシ（p50/p95/p99）、エラーレート、DB/Redis コネクション、キュー滞留長を収集し、SLO と連動したアラートを設定。
* **トレーシング:** OpenTelemetry による分散トレーシングを必須化し、主要ユースケース（予定作成/検索）に手動スパンを付与。
* **ダッシュボード/アラート:** 主要 SLI ごとに Grafana ダッシュボードを準備。重大度に応じたオンコール通知ルール（PagerDuty/Slack）を定義。

### 4.3 キャッシュ戦略
* **競合回避優先:** リソース空き状況は予約競合の原因となるため、キャッシュを行わず常に最新データを参照。
* **個人データキャッシュ:** 個人カレンダー・予定詳細は短期キャッシュ（TTL 5分）で性能向上。
* **権限・マスタデータ:** ユーザー権限は 15分、リソースマスタは 30分の中長期キャッシュ。
* **無効化戦略:** 予約操作時は操作者本人のキャッシュを即座無効化（即座反映）、他の参加者のキャッシュは非同期無効化（遅延許容）。

### 4.4 データベース運用
* **スキーマ運用:** マイグレーションは宣言的に管理し、後方互換を維持した 2 段階リリースを徹底。必須インデックスとパーティショニング（期間・テナント別）方針を明記。
* **レプリカ構成:** リードレプリカを 2 台以上、フェイルオーバーを自動化。隔離レベルは READ COMMITTED（通常）/SERIALIZABLE（重複防止）を使い分け。
* **ロック/デッドロック対策:** 予約更新は時間帯・リソース ID でロック範囲を最小化し、リトライポリシーを定義。
* **監査ログ:** `Audit_Logs` は 90 日で S3 にアーカイブし、ライフサイクルで 1 年後に Glacier 移行。

### 4.5 バックアップ/DR
* **RPO/RTO:** RPO 15 分、RTO 1 時間以内。DB は自動スナップショットと PITR を併用。
* **リージョン障害:** クロスリージョンレプリカ + Infrastructure as Code により 1 時間以内に DR 環境を昇格。
* **復旧手順:** 四半期ごとにリストア演習を実施し、手順書を更新。

### 4.6 セキュリティ・ガバナンス
* **SSO:** SAML 2.0 / OIDC (Azure AD, Okta) を必須。MFA は IdP 側で強制。
* **RBAC:** 部署・役職・委任（代理操作）を組み合わせたロールモデルを定義し、ポリシーのバージョニングと監査ログを保持。
* **秘密情報管理:** AWS Secrets Manager/KMS で暗号化保管し、アプリ側は動的ローテーションに対応。
* **暗号化:** 通信は TLS1.2+、保存データは AES-256。バックアップ/ログも同等に暗号化。
* **脆弱性管理:** 依存パッケージの SCA、コンテナイメージのスキャン、SAST/DAST を CI に組み込み、重大度 High 以上をブロック。

### 4.7 スケールアウト/容量計画

#### オンプレミス構成
* **基本構成:** Webサーバー 4台、DBサーバー 3台（Primary + Read Replica 2台）、Redisサーバー 2台（Master-Slave）
* **スケールアウト:** 負荷増加時はWebサーバーの水平追加（最大8台まで）。ロードバランサー（Nginx/HAProxy）で負荷分散。
* **接続プール:** 各Webサーバーあたり DB接続50-100、Redis接続20-50に設定。
* **性能試験:** 負荷試験シナリオ（朝のスパイク、月末集中）を定義し、毎リリース前に 500 RPS 以上を検証。

#### クラウド拡張オプション
* **オートスケール:** クラウド移行時は CPU/メモリ/レイテンシを指標に最小2→最大20インスタンスで自動スケール。
* **マネージドサービス:** RDS/Azure Database等のマネージドDB、ElastiCache/Redis Cache等のマネージドキャッシュを活用可能。

### 4.8 API 設計品質
* **統一レスポンス:** 成功・エラー問わず統一されたJSONエンベロープ形式を採用し、クライアント側の処理を標準化。
* **詳細エラー情報:** フィールドレベルのエラーコード・メッセージ・代替案を提供し、ユーザー体験を向上。
* **バージョニング:** `/v1` プレフィックスを必須とし、後方互換を 6 か月維持。
* **レートリミット/スロットリング:** テナント・ユーザー単位の上限と 429 応答ポリシーを明記。
* **国際化対応:** エラーメッセージの多言語化とクライアント側での表示制御をサポート。
* **契約テスト:** OpenAPI仕様に基づく自動テストでAPI品質を保証。

### 4.9 テスト戦略
* **単体/統合/契約:** カバレッジ 80% 以上、API 契約テストを PR に必須化。
* **E2E/負荷:** Playwright による全画面 E2E を nightly 実行。k6 等で 500 RPS の負荷試験を定期実施。
* **セキュリティ:** SAST/DAST、依存性スキャン、権限昇格の回帰テストを含める。

### 4.10 CI/CD パイプライン
* **ブランチ戦略:** trunk-based または short-lived feature branch。PR はレビュー 1 名以上必須。
* **品質ゲート:** テスト成功・Lint・セキュリティスキャン・カバレッジ閾値を満たした場合のみマージ。
* **デプロイ:** Blue/Green または Canary を選択し、DB マイグレーションは forward-only + デプロイ前後にヘルスチェック。

### 4.11 データライフサイクル・プライバシー
* **保持期間:** 業務データは 3 年、監査ログは 1 年（法令要件に応じ延長）。削除要求に 30 日以内対応。
* **マスキング/匿名化:** PII は保存前に最小化・マスキングし、分析用は匿名化データセットを別管理。
* **準拠:** GDPR/国内法に準拠した同意・訂正・削除フローを用意。

### 4.12 可用性・インシデント対応
* **オンコール体制:** 24/7 当番表とエスカレーションルールを定義。重大度分類と初動目標（SEV1: 15 分）を設定。
* **ステータスページ:** 障害時は公開ステータスページ/社内告知を更新。PIR（事後分析）を 72 時間以内に実施。

### 4.13 クライアント要件
* **ブラウザ/デバイス:** 最新 2 世代の Chrome/Edge/Safari/Firefox をサポート。レスポンシブ対応と PWA 化を検討。
* **アクセシビリティ:** WCAG 2.1 AA の達成基準（コントラスト比、キーボード操作、代替テキスト）を遵守。
* **ローカライズ:** タイムゾーン/祝日カレンダー対応、i18n フレームワークで多言語化。

### 4.14 ビジネスルール補足
* **リソース権限制御:** 特定リソース（役員会議室、高額備品等）は役職に応じたアクセス制御を適用。
* **競合解決:** 多人数調整時は優先度・必須参加者を指定し、代替案を自動提示。
* **キャンセル/ペナルティ:** キャンセル締切とペナルティのルールを設定・監査ログに記録。

### 4.15 コストと環境分離
* **環境:** dev/stg/prod を分離し、監査ログは prod 専用ストレージで保管。
* **コスト目標:** 月次コスト予算を設定し、タグ付けによるコスト集計とアラートを実施。

### 4.16 依存サービス障害時のフォールバック
* **Redis/SSO 障害:** キャッシュミス時の DB フォールバックとサーキットブレーカ、SSO 障害時の read-only モードを定義。
* **リトライ/バックオフ:** 外部 API 呼び出しに指数バックオフ + ジッターを適用し、ウォームアップ手順を整備。

### 4.17 Phase 2 - AI 機能の品質と責任 (将来実装)
> **Note:** 以下はPhase 2実装時の要件です。

* **精度指標:** AI サジェストの採用率、誤提案率、NPS を追跡し、一定閾値未達時は機能を自動抑制。
* **モデル更新:** オフライン評価 + A/B テストでモデル更新を実施し、リリース手順とロールバック手段を定義。
* **データガバナンス:** 学習データ収集の同意取得、保存期間、再学習禁止データのポリシーを明文化。


## 5. データベース設計案 (Draft Entity Relationship)

AIに生成指示を出すためのベースとなる設計案です。

* `Users` (10,000 records)
* `Events` (数百万 records - パーティショニングが必要)
* `Resources` (数百 records)
* `Event_Participants` (多対多解消用)
* `Audit_Logs` (監査ログ - 膨大になるためS3等へアーカイブ)

