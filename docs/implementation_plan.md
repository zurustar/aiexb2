# 実装作業プラン - Enterprise Schedule Management System (ESMS)

## 概要

本プランは、ESMSの実装を段階的に進めるための詳細な作業計画です。各ファイルの依存関係を考慮し、最適な実装順序を定義しています。また、品質担保のため、各フェーズごとにHuman-in-the-Loopでのレビューポイントを設けています。

## 実装方針

### 基本原則
1. **依存関係の順守**: 下位層から上位層へ（Domain → Repository → Service → Handler → Frontend）
2. **段階的実装**: 各レイヤーを完成させてから次のレイヤーへ進む
3. **品質重視**: 各チェックポイントで人間によるレビューを実施
4. **テスタビリティ**: 各層で独立したテストが可能な設計

### レビューポイント
- **Phase完了時**: 各Phaseの全ファイル実装後にレビュー
- **重要ファイル**: セキュリティ、排他制御など重要なロジックを含むファイルは個別レビュー

### テスト実装のタイミング（重要）

> **AI主導の実装を前提とした推奨アプローチ**

本プランではPhase 15にテストをまとめていますが、**実際の実装では各Phase完了直後に対応するテストを実装することを強く推奨します**。

#### なぜ各Phase直後にテストを書くべきか

1. **即座のフィードバック**: 実装直後にテストを書くことで、実装の誤りを早期発見できる
2. **リグレッション防止**: 次のPhaseの実装時に、前のPhaseの機能が壊れていないか確認できる
3. **実装品質の向上**: テストを書くことで、インターフェース設計の問題点が明らかになる
4. **コンテキストの鮮度**: 実装直後の方が、テストケースを網羅的に考えられる

#### テストの種類別実装タイミング

| テスト種別 | 実装タイミング | 配置場所 | 理由 |
|:---|:---|:---|:---|
| **ユニットテスト** | 各Phase実装直後 | 実装ファイルと同じディレクトリ | 個別機能の正確性を即座に確認 |
| **統合テスト** | Phase 4以降、各Phase完了時 | `backend/tests/integration/` | DB連携が必要な層から |
| **E2Eテスト** | Phase 14完了後 | `frontend/tests/e2e/` | 全体のフローが揃ってから |
| **パフォーマンステスト** | Phase 8完了後 | `backend/tests/performance/` | バックエンド全体が動作してから |

#### 実装フローの例（Phase 2: ドメインモデル）

```
Phase 2: ドメインモデル実装
├─ 2.1 user.go 実装
├─ 2.2 user_test.go 実装 ← 実装直後にテスト
├─ 2.3 resource.go 実装
├─ 2.4 resource_test.go 実装 ← 実装直後にテスト
├─ 2.5 reservation.go 実装
├─ 2.6 reservation_test.go 実装 ← 実装直後にテスト（個別レビュー）
├─ 2.7 audit_log.go 実装
├─ 2.8 audit_log_test.go 実装 ← 実装直後にテスト
└─ Phase 2 チェックポイント（実装+テスト）
```

#### Phase 15の役割変更

Phase 15は「テスト実装」から「テスト統合・品質保証」に変更：
- 既存テストの統合確認
- テストカバレッジレポート作成
- CI/CDパイプラインでのテスト自動実行設定
- E2Eテストの実装
- パフォーマンステストの実装
- テスト実行スクリプトの整備

---

## Phase 1: データベース基盤 (Database Foundation)

### 目的
データベーススキーマとマイグレーションの実装。全ての機能の基盤となるデータ構造を定義。

### 実装ファイル

#### 1.1 データベース初期化スクリプト
- **ファイル**: `database/init/01_create_extensions.sql`
- **内容**: PostgreSQL拡張機能の有効化（UUID、pgvector等）
- **依存**: なし
- **レビュー**: Phase 1完了時

#### 1.2 初期スキーママイグレーション (Up)
- **ファイル**: `backend/migrations/000001_init_schema.up.sql`
- **内容**: 
  - Users テーブル
  - Resources テーブル
  - Reservations テーブル（パーティション設定含む）
  - ReservationInstances テーブル
  - ReservationParticipants テーブル
  - ReservationResources テーブル
  - AuditLogs テーブル
  - 基本インデックス（Phase 1: カレンダー表示最適化）
- **依存**: 1.1
- **レビュー**: ✅ **個別レビュー必須**（データモデルの正確性確認）

#### 1.3 初期スキーママイグレーション (Down)
- **ファイル**: `backend/migrations/000001_init_schema.down.sql`
- **内容**: 全テーブルのDROP処理
- **依存**: 1.2
- **レビュー**: Phase 1完了時

#### 1.4 シードデータ - ユーザー
- **ファイル**: `database/seed/users.sql`
- **内容**: テスト用ユーザーデータ（各ロール）
- **依存**: 1.2
- **レビュー**: Phase 1完了時

#### 1.5 シードデータ - リソース
- **ファイル**: `database/seed/resources.sql`
- **内容**: テスト用会議室・備品データ
- **依存**: 1.2
- **レビュー**: Phase 1完了時

### Phase 1 チェックポイント 🔍
**レビュー内容**:
- スキーマ定義が設計書と一致しているか
- パーティション設定が正しいか
- インデックス戦略が適切か
- シードデータが各種テストに十分か

---

## Phase 2: バックエンド - ドメインモデル (Backend Domain Models)

### 目的
ビジネスロジックの中核となるドメインモデルの定義。他の層から独立した純粋なGoの構造体。

### 実装ファイル

#### 2.1 ユーザードメイン
- **ファイル**: `backend/internal/domain/user.go`
- **内容**: User構造体、Role定数、権限チェックメソッド
- **依存**: なし
- **レビュー**: Phase 2完了時

#### 2.2 リソースドメイン
- **ファイル**: `backend/internal/domain/resource.go`
- **内容**: Resource構造体、ResourceType定数、検証メソッド
- **依存**: なし
- **レビュー**: Phase 2完了時

#### 2.3 予約ドメイン
- **ファイル**: `backend/internal/domain/reservation.go`
- **内容**: 
  - Reservation構造体
  - ReservationInstance構造体
  - Status定数（CONFIRMED, CANCELLED等）
  - RRULE解析・展開ロジック
  - 繰り返し予定の例外処理
- **依存**: 2.1
- **レビュー**: ✅ **個別レビュー必須**（繰り返しロジックの正確性確認）

#### 2.4 監査ログドメイン
- **ファイル**: `backend/internal/domain/audit_log.go`
- **内容**: AuditLog構造体、署名ハッシュ生成メソッド
- **依存**: なし
- **レビュー**: Phase 2完了時

### Phase 2 チェックポイント 🔍
**レビュー内容**:
- ドメインモデルが設計書と一致しているか
- RRULE解析ロジックが正しく実装されているか
- ビジネスルールが適切に表現されているか

---

## Phase 3: バックエンド - 設定・ユーティリティ (Backend Config & Utilities)

### 目的
共通機能とユーティリティの実装。他のレイヤーから利用される基盤機能。

### 実装ファイル

#### 3.1 設定管理
- **ファイル**: `backend/internal/config/config.go`
- **内容**: 環境変数読み込み、DB接続設定、Redis設定、OIDC設定
- **依存**: なし
- **レビュー**: Phase 3完了時

#### 3.2 ロガー
- **ファイル**: `backend/internal/util/logger.go`
- **内容**: 構造化ログ、ログレベル管理、リクエストIDトレース
- **依存**: なし
- **レビュー**: Phase 3完了時

#### 3.3 バリデーター
- **ファイル**: `backend/internal/util/validator.go`
- **内容**: 入力値検証、エラーメッセージ生成、国際化対応
- **依存**: なし
- **レビュー**: Phase 3完了時

#### 3.4 時間ユーティリティ
- **ファイル**: `backend/internal/util/time.go`
- **内容**: タイムゾーン変換、時間範囲重複チェック、営業時間判定
- **依存**: なし
- **レビュー**: Phase 3完了時

#### 3.5 Redisクライアント
- **ファイル**: `backend/internal/cache/redis_client.go`
- **内容**: Redis接続管理、キャッシュ操作、セッション管理
- **依存**: 3.1
- **レビュー**: Phase 3完了時

#### 3.6 ジョブキュー
- **ファイル**: `backend/internal/queue/job_queue.go`
- **内容**: バックグラウンドジョブ管理、リトライ機構、冪等性キー
- **依存**: 3.5
- **レビュー**: Phase 3完了時

### Phase 3 チェックポイント 🔍
**レビュー内容**:
- 設定管理が環境変数を適切に読み込んでいるか
- ログ出力が構造化されているか
- バリデーションエラーメッセージが分かりやすいか

---

## Phase 4: バックエンド - リポジトリ層 (Backend Repository Layer)

### 目的
データアクセス層の実装。DBとの通信を担当し、インターフェースで抽象化。

### 実装ファイル

#### 4.1 ユーザーリポジトリ
- **ファイル**: `backend/internal/repository/user_repository.go`
- **内容**: 
  - UserRepository インターフェース
  - 実装（FindByID, FindBySub, Create, Update）
  - IdP同期処理
- **依存**: 2.1, 3.1
- **レビュー**: Phase 4完了時

#### 4.2 リソースリポジトリ
- **ファイル**: `backend/internal/repository/resource_repository.go`
- **内容**: 
  - ResourceRepository インターフェース
  - 実装（FindByID, Search, CheckAvailability）
  - 空き時間検索（排他制御含む）
- **依存**: 2.2, 3.1
- **レビュー**: ✅ **個別レビュー必須**（排他制御の正確性確認）

#### 4.3 予約リポジトリ
- **ファイル**: `backend/internal/repository/reservation_repository.go`
- **内容**: 
  - ReservationRepository インターフェース
  - 実装（Create, Update, Delete, FindByID, FindByUser）
  - トランザクション管理
  - 排他制御（SERIALIZABLE、FOR UPDATE）
  - 繰り返し予定の展開処理
  - パーティション対応クエリ
- **依存**: 2.3, 3.1
- **レビュー**: ✅ **個別レビュー必須**（排他制御・トランザクション確認）

#### 4.4 監査ログリポジトリ
- **ファイル**: `backend/internal/repository/audit_log_repository.go`
- **内容**: 
  - AuditLogRepository インターフェース
  - 実装（Create, FindByUser, FindByAction）
  - 署名ハッシュ検証
- **依存**: 2.4, 3.1
- **レビュー**: Phase 4完了時

### Phase 4 チェックポイント 🔍
**レビュー内容**:
- 排他制御ロジックが設計書通りに実装されているか
- トランザクション境界が適切か
- エラーハンドリングが適切か
- リトライ戦略が正しく実装されているか

---

## Phase 5: バックエンド - サービス層 (Backend Service Layer)

### 目的
ビジネスロジックの実装。複数のリポジトリを組み合わせてユースケースを実現。

### 実装ファイル

#### 5.1 認証サービス
- **ファイル**: `backend/internal/service/auth_service.go`
- **内容**: 
  - OIDC認証フロー
  - トークン検証
  - セッション管理（Redis）
  - ロール・権限チェック
- **依存**: 4.1, 3.5, `backend/pkg/oidc/client.go`
- **レビュー**: ✅ **個別レビュー必須**（セキュリティ確認）

#### 5.2 予約サービス
- **ファイル**: `backend/internal/service/reservation_service.go`
- **内容**: 
  - 予約作成（排他制御、競合検出、代替案提案）
  - 予約更新（楽観的ロック）
  - 予約キャンセル（キャンセルポリシー適用）
  - 繰り返し予定の一括変更
  - チェックイン処理
- **依存**: 4.3, 4.2, 4.1, 3.6
- **レビュー**: ✅ **個別レビュー必須**（ビジネスロジック確認）

#### 5.3 承認サービス
- **ファイル**: `backend/internal/service/approval_service.go`
- **内容**: 
  - 承認フロー管理
  - 承認者判定
  - 承認・却下処理
- **依存**: 4.3, 4.1, 3.6
- **レビュー**: Phase 5完了時

#### 5.4 通知サービス
- **ファイル**: `backend/internal/service/notification_service.go`
- **内容**: 
  - 通知テンプレート管理
  - メール送信（SMTP）
  - チャット通知
  - リトライ機構
  - 重複送信防止
- **依存**: 4.1, 3.6
- **レビュー**: Phase 5完了時

### Phase 5 チェックポイント 🔍
**レビュー内容**:
- 認証フローが安全に実装されているか
- 予約作成時の排他制御が正しく動作するか
- キャンセルポリシーが適切に適用されるか
- 通知の重複送信が防止されているか

---

## Phase 6: バックエンド - OIDC連携 (Backend OIDC Integration)

### 目的
外部IdPとの連携機能の実装。

### 実装ファイル

#### 6.1 OIDCクライアント
- **ファイル**: `backend/pkg/oidc/client.go`
- **内容**: 
  - OIDC Discovery
  - Authorization Code Flow
  - トークン交換
  - ID Token検証
  - Claims抽出
- **依存**: 3.1
- **レビュー**: ✅ **個別レビュー必須**（セキュリティ確認）

### Phase 6 チェックポイント 🔍
**レビュー内容**:
- OIDC仕様に準拠しているか
- トークン検証が適切か
- エラーハンドリングが適切か

---

## Phase 7: バックエンド - ハンドラー層 (Backend Handler Layer)

### 目的
HTTPリクエスト/レスポンスの処理。APIエンドポイントの実装。

### 実装ファイル

#### 7.1 ミドルウェア
- **ファイル**: `backend/internal/handler/middleware.go`
- **内容**: 
  - 認証ミドルウェア（セッション検証）
  - CSRF対策
  - CORS設定
  - ロギング
  - リクエストIDトレース
  - レート制限
- **依存**: 5.1, 3.2
- **レビュー**: ✅ **個別レビュー必須**（セキュリティ確認）

#### 7.2 認証ハンドラー
- **ファイル**: `backend/internal/handler/auth_handler.go`
- **内容**: 
  - POST /api/v1/auth/login
  - GET /api/v1/auth/callback
  - POST /api/v1/auth/refresh
  - POST /api/v1/auth/logout
- **依存**: 5.1, 7.1
- **レビュー**: Phase 7完了時

#### 7.3 予約ハンドラー
- **ファイル**: `backend/internal/handler/reservation_handler.go`
- **内容**: 
  - GET /api/v1/events
  - POST /api/v1/events
  - GET /api/v1/events/{eventId}
  - PATCH /api/v1/events/{eventId}
  - DELETE /api/v1/events/{eventId}
  - 統一レスポンス形式
  - エラーハンドリング
  - バリデーション
- **依存**: 5.2, 7.1, 3.3
- **レビュー**: Phase 7完了時

#### 7.4 リソースハンドラー
- **ファイル**: `backend/internal/handler/resource_handler.go`
- **内容**: 
  - GET /api/v1/resources
  - GET /api/v1/resources/{resourceId}/availability
- **依存**: 4.2, 7.1
- **レビュー**: Phase 7完了時

#### 7.5 ユーザーハンドラー
- **ファイル**: `backend/internal/handler/user_handler.go`
- **内容**: 
  - GET /api/v1/users/me
  - PATCH /api/v1/users/me
- **依存**: 4.1, 7.1
- **レビュー**: Phase 7完了時

### Phase 7 チェックポイント 🔍
**レビュー内容**:
- APIレスポンスが統一形式に準拠しているか
- エラーハンドリングが適切か
- バリデーションが十分か
- セキュリティ対策（CSRF、認証）が実装されているか

---

## Phase 8: バックエンド - メインエントリーポイント (Backend Main Entry Points)

### 目的
アプリケーションの起動処理とルーティング設定。

### 実装ファイル

#### 8.1 APIサーバー
- **ファイル**: `backend/cmd/api/main.go`
- **内容**: 
  - 設定読み込み
  - DB接続初期化
  - Redis接続初期化
  - ルーティング設定
  - サーバー起動
  - グレースフルシャットダウン
- **依存**: 3.1, 7.1, 7.2, 7.3, 7.4, 7.5
- **レビュー**: Phase 8完了時

#### 8.2 バックグラウンドワーカー
- **ファイル**: `backend/cmd/worker/main.go`
- **内容**: 
  - ジョブキュー接続
  - 通知送信ジョブ
  - 自動キャンセルジョブ
  - 繰り返し予定展開ジョブ
  - パーティション自動作成ジョブ
- **依存**: 3.6, 5.4, 4.3
- **レビュー**: Phase 8完了時

### Phase 8 チェックポイント 🔍
**レビュー内容**:
- サーバーが正常に起動するか
- ルーティングが正しく設定されているか
- グレースフルシャットダウンが動作するか
- バックグラウンドジョブが正常に実行されるか

---

## Phase 9: フロントエンド - 型定義・ユーティリティ (Frontend Types & Utilities)

### 目的
フロントエンドの基盤となる型定義とユーティリティの実装。

### 実装ファイル

#### 9.1 API型定義
- **ファイル**: `frontend/src/types/api.ts`
- **内容**: 
  - APIレスポンス型
  - エラーレスポンス型
  - ページネーション型
  - リクエスト型
- **依存**: なし
- **レビュー**: Phase 9完了時

#### 9.2 ドメインモデル型
- **ファイル**: `frontend/src/types/models.ts`
- **内容**: 
  - User型
  - Reservation型
  - Resource型
  - Role型、Status型
- **依存**: なし
- **レビュー**: Phase 9完了時

#### 9.3 型定義エクスポート
- **ファイル**: `frontend/src/types/index.ts`
- **内容**: 全型定義の再エクスポート
- **依存**: 9.1, 9.2
- **レビュー**: Phase 9完了時

#### 9.4 APIクライアント
- **ファイル**: `frontend/src/lib/api-client.ts`
- **内容**: 
  - Fetch APIラッパー
  - 認証ヘッダー付与
  - エラーハンドリング
  - リトライ機構
- **依存**: 9.1
- **レビュー**: Phase 9完了時

#### 9.5 認証ヘルパー
- **ファイル**: `frontend/src/lib/auth.ts`
- **内容**: 
  - セッション管理
  - ログイン/ログアウト
  - 権限チェック
- **依存**: 9.4
- **レビュー**: Phase 9完了時

#### 9.6 ユーティリティ
- **ファイル**: `frontend/src/lib/utils.ts`
- **内容**: 
  - 日時フォーマット
  - タイムゾーン変換
  - バリデーションヘルパー
- **依存**: なし
- **レビュー**: Phase 9完了時

### Phase 9 チェックポイント 🔍
**レビュー内容**:
- 型定義がバックエンドAPIと一致しているか
- APIクライアントが適切にエラーハンドリングしているか

---

## Phase 10: フロントエンド - カスタムフック (Frontend Custom Hooks)

### 目的
再利用可能なReactフックの実装。

### 実装ファイル

#### 10.1 認証フック
- **ファイル**: `frontend/src/hooks/useAuth.ts`
- **内容**: ログイン状態管理、ユーザー情報取得
- **依存**: 9.5
- **レビュー**: Phase 10完了時

#### 10.2 予定フック
- **ファイル**: `frontend/src/hooks/useEvents.ts`
- **内容**: 予定一覧取得、予定作成・更新・削除
- **依存**: 9.4
- **レビュー**: Phase 10完了時

#### 10.3 リソースフック
- **ファイル**: `frontend/src/hooks/useResources.ts`
- **内容**: リソース検索、空き状況確認
- **依存**: 9.4
- **レビュー**: Phase 10完了時

### Phase 10 チェックポイント 🔍
**レビュー内容**:
- フックが適切にキャッシュを管理しているか
- エラー状態が適切に処理されているか

---

## Phase 11: フロントエンド - 共通UIコンポーネント (Frontend Common UI Components)

### 目的
再利用可能なUIコンポーネントの実装。

### 実装ファイル

#### 11.1 ボタン
- **ファイル**: `frontend/src/components/ui/Button.tsx`
- **内容**: 汎用ボタンコンポーネント
- **依存**: なし
- **レビュー**: Phase 11完了時

#### 11.2 モーダル
- **ファイル**: `frontend/src/components/ui/Modal.tsx`
- **内容**: モーダルダイアログ
- **依存**: なし
- **レビュー**: Phase 11完了時

#### 11.3 日付ピッカー
- **ファイル**: `frontend/src/components/ui/DatePicker.tsx`
- **内容**: 日時選択コンポーネント
- **依存**: 9.6
- **レビュー**: Phase 11完了時

#### 11.4 トースト通知
- **ファイル**: `frontend/src/components/ui/Toast.tsx`
- **内容**: 通知メッセージ表示
- **依存**: なし
- **レビュー**: Phase 11完了時

### Phase 11 チェックポイント 🔍
**レビュー内容**:
- UIコンポーネントが再利用可能か
- アクセシビリティが考慮されているか

---

## Phase 12: フロントエンド - レイアウトコンポーネント (Frontend Layout Components)

### 目的
ページ全体の構造を定義するレイアウトコンポーネントの実装。

### 実装ファイル

#### 12.1 ヘッダー
- **ファイル**: `frontend/src/components/layout/Header.tsx`
- **内容**: ナビゲーション、ユーザーメニュー
- **依存**: 10.1, 11.1
- **レビュー**: Phase 12完了時

#### 12.2 サイドバー
- **ファイル**: `frontend/src/components/layout/Sidebar.tsx`
- **内容**: サイドメニュー
- **依存**: 10.1
- **レビュー**: Phase 12完了時

#### 12.3 フッター
- **ファイル**: `frontend/src/components/layout/Footer.tsx`
- **内容**: フッター情報
- **依存**: なし
- **レビュー**: Phase 12完了時

### Phase 12 チェックポイント 🔍
**レビュー内容**:
- レイアウトが一貫しているか
- レスポンシブデザインが適切か

---

## Phase 13: フロントエンド - 機能別コンポーネント (Frontend Feature Components)

### 目的
ビジネスロジックを含む機能別コンポーネントの実装。

### 実装ファイル

#### 13.1 カレンダーコンポーネント
- **ファイル**: `frontend/src/components/features/calendar/CalendarView.tsx`
- **内容**: カレンダー表示、月/週/日ビュー切替
- **依存**: 10.2, 11.3
- **レビュー**: Phase 13完了時

#### 13.2 予約作成フォーム
- **ファイル**: `frontend/src/components/features/reservation/ReservationForm.tsx`
- **内容**: 予約作成・編集フォーム
- **依存**: 10.2, 10.3, 11.1, 11.2, 11.3
- **レビュー**: Phase 13完了時

#### 13.3 予約詳細
- **ファイル**: `frontend/src/components/features/reservation/ReservationDetail.tsx`
- **内容**: 予約詳細表示、編集・削除ボタン
- **依存**: 10.2, 11.2
- **レビュー**: Phase 13完了時

#### 13.4 承認一覧
- **ファイル**: `frontend/src/components/features/approval/ApprovalList.tsx`
- **内容**: 承認待ち予約一覧
- **依存**: 10.2, 11.1
- **レビュー**: Phase 13完了時

### Phase 13 チェックポイント 🔍
**レビュー内容**:
- コンポーネントが適切に状態管理しているか
- ユーザー体験が良好か

---

## Phase 14: フロントエンド - ページ (Frontend Pages)

### 目的
Next.js App Routerを使用したページの実装。

### 実装ファイル

#### 14.1 ルートレイアウト
- **ファイル**: `frontend/src/app/layout.tsx`
- **内容**: 全ページ共通レイアウト、メタデータ
- **依存**: 12.1, 12.2, 12.3
- **レビュー**: Phase 14完了時

#### 14.2 トップページ
- **ファイル**: `frontend/src/app/page.tsx`
- **内容**: ログイン前のランディングページ
- **依存**: 14.1
- **レビュー**: Phase 14完了時

#### 14.3 ログインページ
- **ファイル**: `frontend/src/app/(auth)/login/page.tsx`
- **内容**: ログインボタン（OIDC認証開始）
- **依存**: 10.1
- **レビュー**: Phase 14完了時

#### 14.4 コールバックページ
- **ファイル**: `frontend/src/app/(auth)/callback/page.tsx`
- **内容**: OIDC認証後のコールバック処理
- **依存**: 10.1
- **レビュー**: Phase 14完了時

#### 14.5 ダッシュボードページ
- **ファイル**: `frontend/src/app/dashboard/page.tsx`
- **内容**: カレンダー表示、予定一覧
- **依存**: 13.1, 10.2
- **レビュー**: Phase 14完了時

#### 14.6 予定管理ページ
- **ファイル**: `frontend/src/app/events/page.tsx`
- **内容**: 予定一覧、検索、フィルタ
- **依存**: 13.2, 13.3, 10.2
- **レビュー**: Phase 14完了時

#### 14.7 リソース管理ページ
- **ファイル**: `frontend/src/app/resources/page.tsx`
- **内容**: リソース検索、空き状況確認
- **依存**: 10.3
- **レビュー**: Phase 14完了時

### Phase 14 チェックポイント 🔍
**レビュー内容**:
- ページ遷移が正しく動作するか
- 認証が適切に機能しているか
- SEO対策が実装されているか

---

## Phase 15: 運用スクリプト・テスト (Operational Scripts & Tests)

### 目的
運用に必要なスクリプトとテストの実装。

### 実装ファイル

#### 15.1 マイグレーションスクリプト
- **ファイル**: `backend/scripts/migrate.sh`
- **内容**: マイグレーション実行スクリプト
- **依存**: なし
- **レビュー**: Phase 15完了時

#### 15.2 シードデータ投入
- **ファイル**: `backend/scripts/seed.go`
- **内容**: テストデータ投入プログラム
- **依存**: 4.1, 4.2
- **レビュー**: Phase 15完了時

#### 15.3 セットアップスクリプト
- **ファイル**: `scripts/setup.sh`
- **内容**: 初回環境構築スクリプト
- **依存**: なし
- **レビュー**: Phase 15完了時

#### 15.4 開発環境起動スクリプト
- **ファイル**: `scripts/dev.sh`
- **内容**: Docker Compose起動スクリプト
- **依存**: なし
- **レビュー**: Phase 15完了時

#### 15.5 テスト実行スクリプト
- **ファイル**: `scripts/test.sh`
- **内容**: 全テスト実行スクリプト
- **依存**: なし
- **レビュー**: Phase 15完了時

#### 15.6 バックエンドユニットテスト
- **ファイル**: `backend/tests/unit/*_test.go`
- **内容**: ドメインモデル、サービス層のテスト
- **依存**: Phase 2-5の実装
- **レビュー**: Phase 15完了時

#### 15.7 バックエンド統合テスト
- **ファイル**: `backend/tests/integration/*_test.go`
- **内容**: API、DB連携のテスト
- **依存**: Phase 4-8の実装
- **レビュー**: Phase 15完了時

### Phase 15 チェックポイント 🔍
**レビュー内容**:
- スクリプトが正常に動作するか
- テストカバレッジが十分か
- テストが適切に失敗するか

---

## Phase 16: CI/CD・ドキュメント (CI/CD & Documentation)

### 目的
継続的インテグレーション・デプロイメントの設定とドキュメント整備。

### 実装ファイル

#### 16.1 CI設定
- **ファイル**: `.github/workflows/ci.yml`
- **内容**: Lint、テスト、ビルドの自動実行
- **依存**: 15.5
- **レビュー**: Phase 16完了時

#### 16.2 CD設定（Future）
- **ファイル**: `.github/workflows/deploy.yml`
- **内容**: 自動デプロイ設定（将来実装）
- **依存**: 16.1
- **レビュー**: Phase 16完了時

### Phase 16 チェックポイント 🔍
**レビュー内容**:
- CIが正常に動作するか
- テストが自動実行されるか

---

## 検証計画 (Verification Plan)

### 自動テスト

#### バックエンドテスト
```bash
# ユニットテスト実行
cd backend
go test ./internal/... -v -cover

# 統合テスト実行
cd backend
go test ./tests/integration/... -v

# 全テスト実行
make test
```

#### フロントエンドテスト
```bash
# ユニットテスト実行
cd frontend
npm test

# E2Eテスト実行（Playwright）
cd frontend
npm run test:e2e
```

### 手動検証

#### 1. 開発環境起動確認
```bash
# Docker Compose起動
make up

# 確認項目:
# - フロントエンド: http://localhost:3000 にアクセス可能
# - バックエンドAPI: http://localhost:8080/api/v1/health にアクセス可能
# - PostgreSQL: ポート5432で接続可能
# - Redis: ポート6379で接続可能
```

#### 2. 認証フロー確認
1. ブラウザで http://localhost:3000 にアクセス
2. ログインボタンをクリック
3. IdP（テスト環境）でログイン
4. ダッシュボードにリダイレクトされることを確認
5. ユーザー情報が表示されることを確認

#### 3. 予約作成フロー確認
1. ダッシュボードから「新規予約」をクリック
2. 予約情報を入力（タイトル、日時、リソース、参加者）
3. 「作成」ボタンをクリック
4. 予約が正常に作成されることを確認
5. カレンダーに予約が表示されることを確認

#### 4. 排他制御確認
1. 2つのブラウザウィンドウを開く
2. 両方で同じリソース・時間帯の予約を同時に作成
3. 片方が成功し、もう片方が競合エラーになることを確認
4. 代替案が提示されることを確認

#### 5. 繰り返し予定確認
1. 繰り返し予定を作成（例: 毎週月曜日、4回）
2. カレンダーに4つのインスタンスが表示されることを確認
3. 1つのインスタンスを個別に編集
4. 他のインスタンスに影響がないことを確認

---

## 実装時の注意事項

### セキュリティ
- [ ] 全ての入力値をバリデーション
- [ ] SQLインジェクション対策（プリペアドステートメント使用）
- [ ] XSS対策（エスケープ処理）
- [ ] CSRF対策（トークン検証）
- [ ] 認証・認可の適切な実装

### パフォーマンス
- [ ] N+1問題の回避
- [ ] 適切なインデックスの使用
- [ ] キャッシュ戦略の実装
- [ ] ページネーションの実装

### 保守性
- [ ] コメントの適切な記述
- [ ] エラーメッセージの分かりやすさ
- [ ] ログの適切な出力
- [ ] テストの十分なカバレッジ

---

## まとめ

本プランは、ESMSの実装を16のPhaseに分割し、各Phaseで実装するファイルと依存関係を明確にしています。各Phaseの完了時にHuman-in-the-Loopでのレビューを実施することで、品質を担保しながら段階的に実装を進めることができます。

特に重要なファイル（排他制御、認証、セキュリティ関連）については個別レビューを設けており、慎重な実装が可能です。
