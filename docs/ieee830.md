<!--
Depends On: docs/requirements.md, docs/usecases.md
Depended On By: docs/basic_design.md
-->
# ソフトウェア要求仕様書 (SRS)
**Software Requirements Specification**

| 項目 | 内容 |
| :--- | :--- |
| **プロジェクト名称** | 企業向け次世代統合スケジュール管理システム |
| **文書バージョン** | 1.0.0 |
| **作成日** | 2025年11月23日 |
| **対象システム** | Enterprise Schedule Management System (ESMS) |


## 1. はじめに (Introduction)

### 1.1 目的 (Purpose)
本文書は、企業向け統合スケジュール管理システムの機能要件および非機能要件を定義するものである。本仕様書は、設計、実装、および検証（テスト）の基準となる。

### 1.2 適用範囲 (Scope)
本システムは、全社規模（10,000名未満）のスケジュール管理、会議室および備品のリソース管理を一元化するWebアプリケーションである。
従来の静的な管理に加え、生成AI（LLM）を活用した「スマート日程調整機能」を実装し、日程調整にかかる工数を劇的に削減することを目標とする。

### 1.3 定義・略語 (Definitions, Acronyms, and Abbreviations)
* **User:** 本システムを利用するすべての社員。
* **Resource:** 予約対象となる会議室、備品、社用車などの物理資産。
* **Conflict:** 同一リソースまたは同一ユーザーに対する重複予約の状態（ダブルブッキング）。
* **AIDD:** AI-Driven Development（AI駆動開発）。本プロジェクトの開発手法。
* **SSO:** Single Sign-On。


## 2. 全体説明 (Overall Description)

### 2.1 製品の展望 (Product Perspective)
本システムは、社内イントラネットまたは閉域網（VPN）を経由して利用されるクラウドネイティブ・アプリケーションである。
既存の社内統合ID基盤（IdP）と連携し、ユーザー管理を行う。また、将来的な外部カレンダー（Microsoft 365 / Google Workspace）とのAPI連携を見据えたアーキテクチャを採用する。



### 2.2 ユーザー特性 (User Characteristics)
| ユーザー区分 | 特性・役割 |
| :--- | :--- |
| **一般社員** | 自身の予定管理、会議招集、リソース予約を行う主要ユーザー。ITリテラシーは多様であるため、直感的なUIが求められる。 |
| **秘書/代理人** | 役員等のスケジュールを代理で操作する権限を持つ。迅速かつ正確な操作（ショートカット等）を好むパワーユーザー。 |
| **システム管理者** | マスタ管理、監査ログ確認、システム設定を行う。 |

### 2.3 制約事項 (Constraints)
* **スケーラビリティ:** 朝の始業時（9:00-9:30）に全社員の20%が同時アクセスしても、レスポンス遅延が発生しないこと。
* **ブラウザ互換性:** Google Chrome, Microsoft Edgeの最新版、およびモバイル（iOS/Android）の標準ブラウザに対応すること。
* **開発言語:** AIコード生成の精度を高めるため、バックエンドはGo (Golang) またはNode.js (TypeScript)、フロントエンドはReact (Next.js) を採用すること。


## 3. 個別要件 (Specific Requirements)

本セクションでは、システムが満たすべき詳細要件を、ユースケースと対応付けて定義する。

### 3.1 外部インターフェース要件 (External Interface Requirements)
* **3.1.1 ユーザーインターフェース:**
    * レスポンシブデザインを採用し、PCとモバイルで最適化された表示を提供すること。
    * カレンダー表示は「日・週・月・グループ」の切り替えが可能であること。
* **3.1.2 ソフトウェアインターフェース:**
    * **IdP連携:** SAML 2.0 または OIDC による認証連携を必須とし、MFA（多要素認証）はIdP側で強制する。
    * **通知連携:** SMTPサーバー（メール）および社内チャットツールへのWebhook通知。
    * **監視連携:** ECS FireLens (Fluent Bit) 経由でのログ転送、および Datadog/Prometheus へのメトリクス送信。

### 3.2 機能要件 (Functional Requirements)

#### 3.2.1 スケジュール・リソース管理 (Core)
* **REQ-01: 予定のCRUD**
    * ユーザーは自身の予定を作成、参照、更新、削除できること。
    * **UC-01（新規予定登録）** に従い、参加者とリソース（会議室）を同時に確保できること。
* **REQ-02: 排他制御 (Conflict Resolution)**
    * システムは、同一リソース・同一時間帯への重複予約を**100%阻止**しなければならない。
    * 排他制御は悲観的ロック（SELECT FOR UPDATE）により実装し、ダブルブッキングを物理的に防止すること。
    * ロック取得タイムアウトは5秒以内とし、タイムアウト時は適切なエラーメッセージを返却すること。
    * 競合発生時は、代替リソース・時間帯を自動検索し、最大3件の候補を提示すること。
* **REQ-03: 繰り返し予定**
    * 日次、週次、隔週、月次、年次、曜日指定などの複雑な繰り返しルールをサポートすること。
    * 繰り返し予定の「特定回のみ変更」および「以降すべて変更」に対応すること。

#### 3.2.2 コラボレーション・権限 (Collaboration)
* **REQ-04: 代理操作 (Secretary Mode)**
    * **UC-03（代理人による予定登録）** に従い、権限を付与されたユーザーは他者のカレンダーを操作できること。
    * 代理操作の履歴は、操作者と被操作者が明確に区別されてログに残ること。
* **REQ-05: 公開範囲制御**
    * **UC-04（公開範囲設定）** に従い、「公開」「時間枠のみ公開」「非公開」の制御を行うこと。
#### 3.2.3 高度検索・日程調整機能 (Phase 1)
* **REQ-06: 複合条件検索**
    * システムは、参加者・期間・リソース条件を組み合わせた空き時間検索機能を提供すること。
    * 検索結果は優先度順（移動時間、設備充実度等）で表示し、代替案も自動提示すること。
* **REQ-07: スマート候補提示**
    * システムは、検索条件に合致しない場合、時間帯変更やリソース変更等の代替案を提案すること。

### 3.2.4 AIアシスタント機能 (Phase 2 - 将来実装)
* **REQ-08: スマート日程調整 (Phase 2)**
    * **UC-02（AI日程調整）** に従い、自然言語による指示から、参加者全員の空き時間と適切なリソースを自動抽出し、提案すること。
    * 検索アルゴリズムは、移動時間や「集中作業時間」の確保も考慮することが望ましい。
* **REQ-09: 会議準備支援 (Phase 2)**
    * **UC-09（AIによる会議準備サジェスト）** に従い、予定のタイトルや参加者から、必要な資料テンプレートや過去の議事録をレコメンドする機能を有すること。

#### 3.2.5 拡張機能 (Extensions)
* **REQ-10: 施設・備品管理 (Facility & Equipment)**
    * 会議室だけでなく、プロジェクター、社用車、Wi-Fiルーター等の備品管理に対応すること。
    * 連続予約制限（特定の部屋の占有防止ロジック）を実装すること。
* **REQ-11: 外部連携 (External Collaboration)**
    * **UC-06（外部ゲスト招待）** に従い、社外メールアドレスへの招待状送付と参加可否連携を行うこと。
* **REQ-12: リソース効率化 (Resource Optimization)**
    * **UC-07（チェックイン）** に従い、利用開始確認と未チェックイン時の自動キャンセル・開放を行うこと。
    * **UC-08（予定延長）** に従い、終了直前のクイック延長操作と、直後の予約確認ロジックを実装すること。
* **REQ-13: リソース権限制御 (Resource Access Control)**
    * 特定リソース（役員会議室、高額備品等）について、ユーザーの役職に応じたアクセス制御を実装すること。
* **REQ-14: キャンセルポリシー (Cancellation Policy)**
    * **UC-11（予定のキャンセルとペナルティ確認）** に従い、直前キャンセルの警告およびペナルティ（ログ記録等）のビジネスルールを適用すること。



### 3.3 性能要件 (Performance Requirements)
* **REQ-P1:** ページロードおよびカレンダー描画は、95%のリクエストにおいて **1.0秒以内** に完了すること。
* **REQ-P2:** 予約実行処理（排他チェック含む）は、**2.0秒以内** に完了すること。
* **REQ-P3:** システムは、秒間 **500リクエスト (500 RPS)** の負荷に耐えうること。
* **REQ-P4:** 朝の始業時スパイク（9:00-9:30）において、**2,000人同時接続**を処理できること。
* **REQ-P5:** 排他制御処理において、ロック保持時間は**500ms以内**、デッドロック発生率は**0.1%以下**を維持すること。
* **REQ-P6:** キャッシュ戦略において、リソース空き状況は競合回避のためキャッシュせず、個人データのみ短期キャッシュ（5分以内）を適用すること。
* **REQ-P7:** 権限データは15分、リソースマスタは30分のキャッシュTTLを設定すること。
* **REQ-P8:** キャッシュ無効化は、操作者本人は即時無効化（Read-Your-Writes）、他ユーザーは非同期無効化（Eventual Consistency）とする。

### 3.4 インフラ要件 (Infrastructure Requirements)
* **REQ-INF1:** オンプレミス環境での冗長化構成を基本とし、単一障害点を排除すること。
* **REQ-INF2:** Docker コンテナ化により、クラウド環境への移行が可能であること。
* **REQ-INF3:** ロードバランサーによる負荷分散で、Webサーバーの水平スケールに対応すること。

### 3.4 データベース要件 (Database Requirements)
* **REQ-DB1:** データ整合性を保つため、ACID特性を備えたRDBMS（PostgreSQL等）を使用すること。
* **REQ-DB2:** 読み取り負荷分散のため、リードレプリカ構成およびRedisによるキャッシュ層を設けること。

### 3.5 セキュリティ要件 (Security Requirements)
* **REQ-SEC1:** 通信はすべてHTTPS (TLS 1.2以上) で暗号化すること。
* **REQ-SEC2:** クロスサイトスクリプティング (XSS)、SQLインジェクション、CSRF等の一般的なWeb脆弱性対策を実装すること。
* **REQ-SEC3:** すべての更新操作（作成・変更・削除）について、操作ユーザー、タイムスタンプ、操作内容を監査ログとして **1年間** 保持すること。
* **REQ-SEC4:** 秘密情報（DBパスワード、APIキー等）は、AWS Secrets Manager または KMS で暗号化管理し、コード内にハードコードしないこと。
* **REQ-SEC5:** 依存ライブラリの脆弱性スキャン (SCA) およびコンテナイメージスキャンをCIパイプラインに組み込み、Critical/High 脆弱性をブロックすること。
* **REQ-SEC6:** ロールベースアクセス制御 (RBAC) は、部署・役職・委任を組み合わせ、ポリシーのバージョニング管理を行うこと。

### 3.6 運用・可観測性要件 (Operational & Observability Requirements)
* **REQ-OPS1 (Logs):** アプリケーションログは構造化JSON形式で出力し、リクエストIDによる分散トレーシングを可能にすること。PIIは出力時にマスクすること。
* **REQ-OPS2 (Metrics):** REDメソッド (Rate, Errors, Duration) に基づくメトリクス（RPS, Latency p95/p99, Error Rate）およびDB/Redis接続数、キュー滞留長を収集すること。
* **REQ-OPS3 (Tracing):** OpenTelemetry を導入し、主要ユースケース（予約作成、検索）の分散トレーシングを実施すること。
* **REQ-OPS4 (Alerts):** SLO (Availability 99.9%, Latency目標) に基づくアラートを設定し、重大度に応じた通知（PagerDuty/Slack）を行うこと。
* **REQ-OPS5 (Cost):** 環境（dev/stg/prod）ごとにコストを分離し、月次予算超過時のアラートを設定すること。

### 3.7 可用性・災害復旧要件 (Availability & DR Requirements)
* **REQ-DR1 (RPO/RTO):** 目標復旧時点 (RPO) は15分、目標復旧時間 (RTO) は1時間以内とすること。
* **REQ-DR2 (Backup):** DBは自動スナップショットに加え、ポイントインタイムリカバリ (PITR) を有効化すること。
* **REQ-DR3 (Redundancy):** クロスリージョンレプリケーションまたはIaCによるDR環境の迅速な立ち上げ（1時間以内）を可能にすること。
* **REQ-DR4 (Fallback):** Redis障害時はDBフォールバック、SSO障害時はRead-Onlyモードへの縮退運転を定義すること。
* **REQ-DR5 (Drill):** 四半期ごとの復旧演習を実施可能な手順書を整備すること。

### 3.8 品質・開発プロセス要件 (Quality & Development Requirements)
* **REQ-DEV1 (API):** APIレスポンスは統一されたJSONエンベロープ形式（成功・エラー共通）を採用し、詳細なエラーコードと代替案を含めること。
* **REQ-DEV2 (Test):** 単体・統合テストのカバレッジ80%以上を維持し、OpenAPI仕様に基づく契約テストをCIで強制すること。
* **REQ-DEV3 (CI/CD):** 静的解析 (Lint)、セキュリティスキャン、テスト通過をマージ条件とする品質ゲートを設けること。
* **REQ-DEV4 (Deploy):** DBマイグレーションは後方互換性を維持し、無停止デプロイ（Blue/Green等）に対応すること。

### 3.9 データライフサイクル要件 (Data Lifecycle Requirements)
* **REQ-DATA1:** 業務データは3年間保持し、その後アーカイブまたは削除すること。
* **REQ-DATA2:** 監査ログは1年間オンライン保持し、その後コールドストレージへ移行して合計3年間保持すること。
* **REQ-DATA3:** 個人情報 (PII) は最小化して保存し、分析用データセット作成時は匿名化・仮名化処理を行うこと。

### 3.10 AI品質・ガバナンス要件 (AI Quality & Governance - Phase 2)
* **REQ-AI1 (Metrics):** AIサジェストの採用率、誤提案率、NPSを指標として計測し、品質低下時は機能を自動抑制（キルスイッチ）すること。
* **REQ-AI2 (Governance):** 学習データへの個人情報混入を防止し、再学習禁止データの取り扱いポリシーを遵守すること。
* **REQ-AI3 (Update):** モデル更新時はオフライン評価およびA/Bテストを経てリリースすること。


## 4. 付録: ユースケース詳細 (Appendix: Use Case Details)

### UC-01: 会議室を伴う新規予定の登録
* **アクター:** 一般社員
* **事前条件:** ログイン済み
* **基本フロー:**
    1. ユーザーが日時・タイトル・参加者を入力。
    2. システムが参加者の空き状況を表示。
    3. ユーザーがリソースを選択。
    4. システムが排他チェックを行い、予約を確定。
* **例外フロー:** リソース重複時、システムはエラーを返し代替案を提示。

### 3.2.3 AIアシスタント機能 (Future Scope)
> **Note:** 本機能群（REQ-06, REQ-10）は将来のリリースで実装予定です。

**REQ-06: スマート日程調整 (Future Scope)**
*   **概要:** 自然言語による指示で、複数人の空き時間を検索し、最適な日時と会議室を提案する。
*   **入力:** 「来週の午後、AさんとBさんと予算会議をしたい」等のテキスト。
*   **出力:** 候補日時リスト（3件程度）。
*   **制約:** 外部LLM APIの応答時間は6秒以内を目標とする（SLA除外）。

**REQ-10: 会議準備支援 (Future Scope)**
*   **概要:** 会議のタイトルや参加者に基づき、過去の関連議事録や適切なドキュメントテンプレートをレコメンドする。
*   **トリガー:** 予定詳細画面の表示時。

### UC-02: AIアシスタントによるスマート日程調整
* **アクター:** 一般社員
* **基本フロー:**
    1. ユーザーが「来週、AさんとBさんと会議したい」と入力。
    2. AIが意図を解析し、空き時間とリソースをクロス検索。
    3. 最適な候補を3件提示。
    4. ユーザーが選択し、予約確定。

### UC-03: 代理人による予定登録
* **アクター:** 秘書
* **基本フロー:**
    1. 役員カレンダーへモード切り替え。
    2. 予定登録を実施。
    3. システムは「登録者=秘書」「所有者=役員」として記録。

### UC-09: AIによる会議準備サジェスト
* **アクター:** 一般社員 / AIアシスタント
* **基本フロー:** 予定詳細を開くと、AIがタイトルを解析し、関連する過去議事録やテンプレートを提案する。

### UC-11: 予定のキャンセルとペナルティ確認
* **アクター:** 一般社員
* **基本フロー:** 予定キャンセル時、ポリシー（例: 24時間前）を確認し、違反時は警告を表示して監査ログに記録する。

### UC-04: 公開範囲設定とプライバシー制御
* **アクター:** 一般社員
* **基本フロー:**
    1. ユーザーが予定作成時に公開設定（非公開/Busyのみ）を選択。
    2. システムが設定を保存。
    3. 他ユーザー閲覧時、詳細をマスクして表示。

### UC-05: 繰り返し予定の変更・削除
* **アクター:** 一般社員
* **基本フロー:**
    1. ユーザーが繰り返し予定の1つを選択し変更。
    2. システムが「今回のみ」「以降すべて」等の選択肢を提示。
    3. 「今回のみ」選択時、当該インスタンスを例外として切り離して保存。

### UC-06: 外部ゲストの招待と連携
* **アクター:** 一般社員
* **基本フロー:**
    1. ユーザーが社外メールアドレスを参加者に追加。
    2. システムがiCalendar形式の招待メールを送信。
    3. ゲストがメールから参加/不参加を回答。
    4. システムが外部レスポンスを受け取りステータス更新。

### UC-07: 会議室チェックインと自動開放
* **アクター:** 一般社員
* **基本フロー:**
    1. 開始時刻付近にユーザーがチェックイン操作。
    2. システムが利用中ステータスへ変更。
* **例外フロー:**
    * 15分経過してもチェックインがない場合、システムが自動キャンセルしリソースを開放。

### UC-08: 予定の延長
* **アクター:** 一般社員
* **基本フロー:**
    1. 終了10分前にシステムが延長を提案。
    2. ユーザーが延長を選択。
    3. システムが直後の予約を確認し、空きがあれば延長確定。
